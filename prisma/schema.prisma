datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model email_training {
  id              Int     @id @default(autoincrement())
  user_email      String  @db.VarChar
  email_id        String  @unique @db.VarChar
  from            String  @db.VarChar
  subject         String  @db.VarChar
  body            String
  ai_answer       String  @db.VarChar
  confidence      Float   @db.Real
  heuristics_used Boolean @default(false)
}

model processed_daily_summary {
  id         Int      @id @default(autoincrement())
  user_id    Int
  created_at DateTime @default(now()) @db.Timestamptz(6)
  user       user     @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@index([user_id])
}

model processed_email {
  id             String   @id @db.VarChar
  user_id        Int
  processed_at   DateTime @default(now()) @db.Timestamptz(6)
  category       String   @db.VarChar
  extracted_task String?  @db.Text
  ai_answer      String   @db.VarChar
  history_id     Decimal  @db.Decimal(20, 0)
  user           user     @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@index([user_id])
  @@index([user_id, category])
  @@index([user_id, history_id(sort: Desc)])
}

model user_account_access {
  id                     Int      @id @default(autoincrement())
  access_token           String   @db.VarChar
  refresh_token          String   @db.VarChar
  expires_at             DateTime @db.Timestamptz(6)
  needs_reauthentication Boolean  @default(false)
  created_at             DateTime @default(now()) @db.Timestamptz(6)
  updated_at             DateTime @default(now()) @db.Timestamptz(6)
  user_email             String   @unique @db.VarChar
  user                   user     @relation(fields: [user_email], references: [email], onDelete: Cascade)
}

model user_token_usage_stat {
  id              Int      @id @default(autoincrement())
  date            DateTime @default(dbgenerated("CURRENT_DATE")) @db.Date
  month           Int      @default(dbgenerated("EXTRACT(MONTH FROM CURRENT_DATE)"))
  year            Int      @default(dbgenerated("EXTRACT(YEAR FROM CURRENT_DATE)"))
  tokens_consumed BigInt   @default(0)
  created_at      DateTime @default(now()) @db.Timestamptz(6)
  updated_at      DateTime @default(now()) @db.Timestamptz(6)
  user_email      String   @db.VarChar
  user            user     @relation(fields: [user_email], references: [email], onDelete: Cascade)

  @@unique([date, user_email])
  @@index([date])
  @@index([user_email])
  @@index([user_email, month, year])
}

enum subscription_status {
  ACTIVE
  CANCELLED
  PAST_DUE
  UNPAID
}

model user {
  id                         Int                       @id @default(autoincrement())
  email                      String                    @unique @db.VarChar
  subscription_status        subscription_status       @default(UNPAID)
  last_successful_payment_at DateTime?                 @db.Timestamptz(6)
  last_payment_attempt_at    DateTime?                 @db.Timestamptz(6)
  created_at                 DateTime                  @default(now()) @db.Timestamptz(6)
  updated_at                 DateTime                  @default(now()) @db.Timestamptz(6)
  processed_daily_summaries  processed_daily_summary[]
  processed_emails           processed_email[]
  user_token_usage_stats     user_token_usage_stat[]
  user_email_rules           user_email_rule[]
  auto_cleanup_settings      auto_cleanup_setting[]
  user_account_access        user_account_access?
  setup_completed            Boolean                   @default(false)
}

enum cleanup_action {
  DELETE
  ARCHIVE
  NOTHING
}

model auto_cleanup_setting {
  id             Int            @id @default(autoincrement())
  user_id        Int
  mail_label     String         @db.VarChar
  after_days_old Int            @default(7)
  cleanup_action cleanup_action @default(NOTHING)
  created_at     DateTime       @default(now()) @db.Timestamptz(6)
  updated_at     DateTime       @default(now()) @db.Timestamptz(6)

  user user @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@unique([mail_label, user_id])
  @@index([user_id])
}

model user_email_rule {
  id           Int      @id @default(autoincrement())
  user_id      Int
  description  String
  semantic_key String
  name         String   @db.VarChar
  mail_label   String   @db.VarChar
  created_at   DateTime @default(now()) @db.Timestamptz(6)
  updated_at   DateTime @default(now()) @db.Timestamptz(6)

  user user @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@index([user_id])
}

model email_embedding {
  id        Int                         @id @default(autoincrement())
  email_id  String                      @db.VarChar
  embedding Unsupported("vector(1024)")
}
